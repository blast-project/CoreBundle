{#

This file is part of the Libre Informatique CoreBundle package.

(c) Baptiste SIMON <baptiste.simon _AT_ libre-informatique.fr>
(c) Libre Informatique [http://www.libre-informatique.fr/]

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.

#}

{% extends 'SonataAdminBundle::standard_layout.html.twig' %}
{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('bundles/blastcore/css/edit.css') }}" />
    <link rel="stylesheet" href="{{ asset('bundles/blastcore/css/list.css') }}" />
    <link rel="stylesheet" href="{{ asset('bundles/blastcore/css/main.css') }}" />
{% endblock %}

{% block sonata_wrapper %}
    {{ parent() }}
    {% block bottom_js %}{% endblock %}
{% endblock %}

{% block sonata_sidebar_search %}
    {% dump %}
    <form action="{{ path('blast_admin_search') }}" method="GET" class="sidebar-form" role="search">
        <div class="custom-search-form">
            <input type="text" name="q" value="{{ app.request.get('q') }}" class="form-control" data-placeholder="{{ 'search_placeholder'|trans({}, 'SonataAdminBundle') }}">
        </div>
        <div id="custom-search-admins">
            <select name="admin">
                {% for admin in getGlobalSearchAdmins() %}
                    <option value="{{ admin }}">{{ admin_pool.getAdminByAdminCode(admin).label|trans() }}</option>
                {% endfor %}
            </select>
        </div>
    </form>

    <script>
        $(document).ready(function(){
            var searchForm = $("form.sidebar-form[role=search]");
            var ajaxSearchUrl = searchForm.attr('action');
            var searchAdminSelect = searchForm.find('select[name=admin]');

            function searchFormatResult(item) {
               var markup = '<div class="row-fluid">' + item.label + '</div>';
               return markup;
            }

            function searchFormatSelection(item) {
               return item.label;
            }

            searchForm.find("input[name=q]").select2({
                minimumInputLength: 1,
                ajax: {
                    url: ajaxSearchUrl,
                    dataType: 'json',
                    quietMillis: 250,
                    data: function (term, page) {
                        return {
                            q: term,
                            admin: searchAdminSelect.find('option:selected').attr('value')
                        };
                    },
                    results: function (data, page) {
                        return {
                            results: data.results
                        };
                    },
                    cache: true
                },
                escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
                formatResult: searchFormatResult,
                formatSelection: searchFormatSelection
            });

            searchForm.find("input[name=q]").on("change", function(e){

                if (e.added !== undefined && e.added.link !== undefined) {
                    console.log(e.added.link);
                    window.location = e.added.link;
                }
            });
        });
    </script>
{% endblock sonata_sidebar_search %}


{# Temporary fix for fr_FR locale scripts #}
{% block javascripts %}
    {% block sonata_javascript_config %}
        {{ parent() }}
    {% endblock %}

    {% block sonata_javascript_pool %}
         {{ parent() }}
    {% endblock %}

    {% set locale = app.request.locale %}
    {# localize moment #}
    {% if locale[:2] != 'en' %}
        {% if locale == 'fr_FR' %}{% set locale = 'fr' %}{% endif %}
        <script src="{{ asset('bundles/sonatacore/vendor/moment/locale/' ~ locale|replace({'_':'-'}) ~ '.js') }}"></script>
    {% endif %}

    {# localize select2 #}
    {% if sonata_admin.adminPool.getOption('use_select2') %}
        {% if locale == 'pt' %}{% set locale = 'pt_PT' %}{% endif %}

        {# omit default EN locale #}
        {% if locale[:2] != 'en' %}
            <script src="{{ asset('bundles/sonatacore/vendor/select2/select2_locale_' ~ locale|replace({'_':'-'}) ~ '.js') }}"></script>
        {% endif %}
    {% endif %}
{% endblock javascripts %}

